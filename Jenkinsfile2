node('VM-B') {
try {
stage ('Copy artifacts'){
    sh '''rm -f /opt/jenkins/workspace/job2/target/*.war'''
    copyArtifacts filter: 'target/*.war', fingerprintArtifacts: true, projectName: 'job1', selector: lastSuccessful()
    echo 'Copy artifacts: COMPLETED SUCCESSFULLY!'
    }

stage ('Buckup artifacts'){
    sh '''rm -f /opt/artifacts/old/*.war && cp /opt/artifacts/current/*.war /opt/artifacts/old/ && 
    cp /opt/jenkins/workspace/job2/target/*.war /opt/artifacts/current/ &&
    scp -r /opt/artifacts/ jenkins@10.40.1.100:/opt/buckup_artifacts/'''
    echo 'Buckup artifacts: COMPLETED SUCCESSFULLY!'
    }

stage ('Deployment'){
    sh '''/opt/wildfly/bin/jboss-cli.sh -c <<EOF
    undeploy name=scratch-simple-webapp-1.0-SNAPSHOT.war
    deployment-info --name=scratch-simple-webapp-1.0-SNAPSHOT.war
    deploy /opt/artifacts/current/scratch-simple-webapp-1.0-SNAPSHOT.war
    /deployment=scratch-simple-webapp-1.0-SNAPSHOT.war:read-attribute(name=status)
    q
    EOF'''
    echo 'Deployments: DONE SUCCESSFULLY!'
}
}
finally {
   //unstable 'test'
    if (currentBuild.currentResult == 'SUCCESS') {
            echo 'Build: SUCCESSFULLY!'
        } else {
            emailext attachLog: true, body: '$BUILD_URL', 
       subject: '$PROJECT_NAME - Build # $BUILD_NUMBER - $BUILD_STATUS!', 
       to: 'asilnikov@teplopribor.ru'
        }
}   
}