node{
   checkout([$class: 'GitSCM', branches: [[name: '*/asilnikov']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[url: 'https://github.com/asilnikov/CI-CD-final-task.git']]]);
    properties([[$class: 'GithubProjectProperty', displayName: '', projectUrlStr: 'https://github.com/asilnikov/CI-CD-final-task.git/'], [$class: 'ThrottleJobProperty', categories: [], limitOneJobWithMatchingParams: false, maxConcurrentPerNode: 0, maxConcurrentTotal: 0, paramsToUseForLimit: '', throttleEnabled: false, throttleOption: 'project'], pipelineTriggers([pollSCM('H/5 * * * *')])]); 
    
try {   
    stage('Preparation (Checking out)') { 
	git([url: 'https://github.com/asilnikov/CI-CD-final-task.git', branch: "asilnikov"])
	echo 'Checking out: COMPLETED SUCCESSFULLY!'
	}

stage('Building code') {
	sh '/opt/maven/bin/mvn clean package '
	echo 'building code: COMPLETED SUCCESSFULLY!'
	}

stage('Nexus') {
   nexusPublisher nexusInstanceId: 'Nexus',
   nexusRepositoryId: 'maven-releases',
   packages: [[$class: 'MavenPackage',
   mavenAssetList: [[classifier: '', extension: '',
   filePath: '/opt/jenkins/master/workspace/job1/target/scratch-simple-webapp-1.0-SNAPSHOT.war']],
   mavenCoordinate: [artifactId: 'scratch-simple-webapp-1.0-SNAPSHOT', groupId: 'org.springframework.boot', packaging: 'war', version: '1.0-SNAPSHOT.b${BUILD_NUMBER}']]] 
   echo 'Nexus archives artifacts: COMPLETED SUCCESSFULLY!'
}
stage ('ArchiveArtifacts'){
    archiveArtifacts 'target/*.war'
    echo 'Archive artifacts: : COMPLETED SUCCESSFULLY!'
}
}
finally {
    junit 'target/**/*.xml'
    withSonarQubeEnv('My_Sonar'){
    sh '''/opt/sonar-scanner/bin/sonar-scanner -D sonar.junit.reportPaths=target/surefire-reports/ -D sonar.projectKey=newTest -D sonar.projectVersion=1.0 -D sonar.sources=/opt/jenkins/master/workspace/job1/src/main -D sonar.tests/opt/jenkins/master/workspace/job1/src/test -D sonar.java.binaries=/opt/jenkins/master/workspace/job1/target/classes -D sonar.java.libraries=/opt/jenkins/master/workspace/job1/target/scratch-simple-webapp-1.0-SNAPSHOT/WEB-INF/lib/ -X '''
    }
  //unstable 'test'
    if (currentBuild.currentResult == 'SUCCESS') {
            echo 'Build: SUCCESSFULLY!'
        } else {
            emailext attachLog: true, body: '$BUILD_URL', 
       subject: '$PROJECT_NAME - Build # $BUILD_NUMBER - $BUILD_STATUS!', 
       to: 'asilnikov@teplopribor.ru'
        }
}   
}
